# =============================================================================
# 비즈니스 관리 시스템 Dockerfile
# =============================================================================
# 설명: Django 웹 애플리케이션을 위한 Docker 컨테이너 이미지 빌드 파일
# 작성자: 비즈니스 관리 시스템 개발팀
# 버전: 1.0.0
# =============================================================================

# Python 3.11 slim 이미지를 기본 이미지로 사용
# slim 버전은 경량화된 이미지로 불필요한 패키지가 제거되어 크기가 작음
FROM python:3.11-slim

# =============================================================================
# 환경 변수 설정
# =============================================================================
# PYTHONDONTWRITEBYTECODE=1: .pyc 파일 생성 방지 (성능 향상)
# PYTHONUNBUFFERED=1: Python 출력 버퍼링 비활성화 (실시간 로그 표시)
# DEBIAN_FRONTEND=noninteractive: 패키지 설치 시 사용자 입력 요구 방지
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV DEBIAN_FRONTEND=noninteractive

# =============================================================================
# 작업 디렉토리 설정
# =============================================================================
# 컨테이너 내에서 애플리케이션 코드가 위치할 기본 디렉토리
WORKDIR /app

# =============================================================================
# 시스템 의존성 설치
# =============================================================================
# postgresql-client: PostgreSQL 데이터베이스 클라이언트
# build-essential: C/C++ 컴파일러 및 빌드 도구 (Python 패키지 컴파일용)
# libpq-dev: PostgreSQL C 라이브러리 개발 파일 (psycopg2 패키지용)
# gettext: 국제화 지원 도구 (Django 번역 기능용)
# curl: HTTP 클라이언트 (헬스 체크용)
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        postgresql-client \
        build-essential \
        libpq-dev \
        gettext \
        curl \
    && rm -rf /var/lib/apt/lists/*

# =============================================================================
# Python 의존성 설치
# =============================================================================
# requirements.txt 파일을 컨테이너에 복사
COPY requirements.txt .

# requirements.txt에 명시된 Python 패키지 설치
# --no-cache-dir: 캐시 사용 안 함으로 이미지 크기 최소화
RUN pip install --no-cache-dir -r requirements.txt

# =============================================================================
# 프로젝트 코드 복사
# =============================================================================
# 현재 디렉토리의 모든 파일을 컨테이너의 /app 디렉토리로 복사
COPY . .

# =============================================================================
# 정적 파일 및 미디어 파일 디렉토리 생성
# =============================================================================
# Django 정적 파일과 미디어 파일을 저장할 디렉토리 생성
RUN mkdir -p /app/staticfiles /app/media

# =============================================================================
# 정적 파일 수집
# =============================================================================
# Django의 collectstatic 명령을 실행하여 모든 정적 파일을 staticfiles 디렉토리로 수집
# --noinput: 사용자 입력 없이 자동으로 실행
RUN python manage.py collectstatic --noinput

# =============================================================================
# 비루트 사용자 생성 및 권한 설정
# =============================================================================
# 보안을 위해 root가 아닌 일반 사용자 생성
# --disabled-password: 패스워드 로그인 비활성화
# --gecos '': 사용자 정보 입력 건너뛰기
RUN adduser --disabled-password --gecos '' appuser \
    && chown -R appuser:appuser /app

# 생성된 사용자로 전환
USER appuser

# =============================================================================
# 포트 노출
# =============================================================================
# 컨테이너 외부에서 접속할 포트 번호 (8000)
EXPOSE 8000

# =============================================================================
# 헬스 체크 설정
# =============================================================================
# 컨테이너가 정상적으로 실행되는지 주기적으로 확인
# --interval=30s: 30초마다 실행
# --timeout=30s: 30초 타임아웃
# --start-period=5s: 컨테이너 시작 후 5초 대기
# --retries=3: 3번 실패 시 비정상으로 간주
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/ || exit 1

# =============================================================================
# 애플리케이션 실행
# =============================================================================
# Gunicorn WSGI 서버를 사용하여 Django 애플리케이션 실행
# --bind 0.0.0.0:8000: 모든 IP 주소의 8000 포트에서 접속 허용
# --workers 3: 3개의 워커 프로세스 사용 (성능 향상)
# business_management.wsgi:application: Django WSGI 애플리케이션 지정
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "--workers", "3", "business_management.wsgi:application"]
